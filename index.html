<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Office Temp chart</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.2/p5.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.2/addons/p5.dom.js"></script>
    <script>
var catchup;
var data;
var dataStrings;
var chart;
var options;
var lastValue=0;
var currentVal=0;
var lastUpdated="";
var maxValue=0;
var timer;
var lastTimer=0;
var button;
var readyfordata=false;
google.charts.load("current", {packages:["corechart"]});
google.charts.setOnLoadCallback(drawChart);


function setup()
{
button=createButton('download');
button.position(windowWidth/2,windowHeight*7/10);
button.mousePressed(downloadText);
catchup = createButton("GetToday's Temps");
catchup.position(windowWidth*1/4,windowHeight*7/10);
catchup.mousePressed(downloadToday);
}

function downloadToday()
{if(readyfordata)
  {
  loadStrings("http://data.theodoretech.com/OfficeTempsToday/?key=8385",downloadTodayCallback)
  }
}
function downloadTodayCallback(data)
{
println(data);
var dataSplit=splitTokens(String(data),"_");
println(dataSplit[0]);
print("size"); println(dataSplit.length);
for(var i=0; i<dataSplit.length; i++)
  {
  var dataSplit2=splitTokens(dataSplit[i],",");
  println(dataSplit2);
  var timeOfTemp=splitTokens(dataSplit2[1],":");
  print("Time: "); println(timeOfTemp);
  data.addRow([[int(timeOfTemp[0]),int(timeOfTemp[1]),int(timeOfTemp[2])],float(dataSplit2[2])]);
  //data.addRow([[hour(),minute(),second()],22]);
  //data.addRow([[hour(),minute(),second()],0]);
  chart.draw(data, options);
    
  }
}


function windowResized()
{
options.width=windowWidth;
options.height=windowHeight/2;
button.position=windowWidth/2,windowHeight*7/10;
catchup.position(windowWidth*1/4,windowHeight*7/10);
}

function downloadText()
{var filename="Session-"+hour()+"_"+minute()+"_"+second()+".txt";
saveStrings(dataStrings,filename);
}

function draw()
{
if(millis()-lastTimer>10000||lastTimer==0)
  {if( readyfordata)
    {
    updateData();
    lastTimer=millis();
    }
  }  
}

function updateData()
{
var address="http://data.theodoretech.com/OfficeTemp.json/?key=8385";
loadJSON(address,datapass);
println(address);
}

function datapass(newData)
{var temp=String(lastUpdated);
if(typeof newData.OfficeTemp!="undefined" )
  {if(lastUpdated!=newData.lastUpdated)
    {
  currentVal=newData.OfficeTemp;
  println(newData.OfficeTemp);
  println(newData.lastUpdated);
  lastUpdated=newData.lastUpdated;
  var lastUpdatedParse=splitTokens(lastUpdated,",");
  println(lastUpdatedParse[1]);
  var hourMinSecUpdated=splitTokens(lastUpdatedParse[1],":");
  println(int(hourMinSecUpdated[0]));
  data.addRow([[int(hourMinSecUpdated[0]),int(hourMinSecUpdated[1]),int(hourMinSecUpdated[2])],currentVal]);
  chart.draw(data, options);
  var textDat = document.getElementById("textData");
  textDat.innerHTML +="<br>"+hour()+":"+minute()+":"+second()+", "+currentVal;
  dataStrings+="\r\n"+hour()+":"+minute()+":"+second()+", "+currentVal;
  if(currentVal>maxValue)
    {maxValue=currentVal;
    var maxDat = document.getElementById("maxData");
    maxDat.innerHTML =" Max Temperature is: "+currentVal;
    }
    }
  }
else {println("Failed to parse");}
}


function drawChart() {
      data = new google.visualization.DataTable();
      data.addColumn('timeofday', 'Time of Day');
      data.addColumn('number','Temp');
      //data.addRow([[hour(),minute(),second()],0]);
            options = {
        legend: 'none',
        'width':windowWidth,
        'height':windowHeight/2,
        'hAxis': { 'title': 'Time'},
        'vAxis': { 'title': 'Temperature',
                viewWindow: {
                    min: 0,
                    max: 100
                    }
        },
        animation: {
          duration: 200,
          easing: 'inAndOut',
        }
      };

      chart = new google.visualization.ScatterChart(document.getElementById('animatedshapes_div'));

      // Start the animation by listening to the first 'ready' event.
      google.visualization.events.addOneTimeListener(chart, 'ready', datapass);
      google.visualization.events.addOneTimeListener(chart, 'ready', downloadTodayCallback);

      // Control all other animations by listening to the 'animationfinish' event.
      google.visualization.events.addListener(chart, 'animationfinish', datapass);
      google.visualization.events.addListener(chart, 'animationfinish', downloadTodayCallback);
      chart.draw(data, options);
       readyfordata=true; println("ready for data");
    }
    </script>

    
  </head>
  <body>
  Current Home Office Temperatures
  
    <div id="animatedshapes_div" style="width: 500px; height: 50%;"></div>
 

   <div id="maxData">
  Max Temperature is: 
  </div>
 

   <div id="textData">
   Here is the data: 
   </div>
 </body>
</html>
